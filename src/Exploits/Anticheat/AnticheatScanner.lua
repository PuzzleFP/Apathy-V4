local AnticheatReferences = ImportScript("AnticheatReferenceInstructions")
local DisableAnticheatInstances = ImportScript("DisableAnticheatInstances")
local ScriptProfile = ImportScript("ScriptProfile")

local AnticheatModules = {}
local AnticheatScriptHashes = GetAnticheatScriptHashes()

for _, Script in ipairs(getscripts()) do 
    local ScriptHash = getscripthash(Script)

    if AnticheatScriptHashes[ScriptHash] then
        -- Remove the entry, so we know that this anticheat script has been found 
        AnticheatScriptHashes[ScriptHash] = nil
        AnticheatModules[Script.Name] = Script 
    end
end

for ScriptHash, ScriptName in pairs(AnticheatScriptHashes) do
    -- Attempt to manually search for the script
    -- Manually search for the script through pre-defined instructions
    local AnticheatScript = AnticheatReferences.GetReference(ScriptName)
    
    -- If the anticheat script was found, update the script hash and scan the script for changes
    if AnticheatScript then
        UpdateScriptHash(ScriptName, getscripthash(AnticheatScript))
        local NewScriptProfile = ScriptProfile.BuildProfile(AnticheatScript)
        local ComparisonProfile = ScriptProfile.CompareProfile(GetScriptProfile(ScriptName), NewScriptProfile)       

        -- An anticheat script has changed, report to the server
        if ComparisonProfile.Changed then
            ReportChangedAnticheatInstance(ScriptName, ComparisonProfile)
        end

    else
        -- Report to the server that the anticheat instance in question could not be found
        ReportMissingAnticheatInstance(ScriptName)
    end
end

DisableAnticheatInstances(AnticheatModules)
